import{a as Z}from"./chunk-UKXPGTL3.js";import{a as Y}from"./chunk-XFO6QB5Y.js";import{a as E}from"./chunk-MQB6D6E4.js";import{d as X}from"./chunk-46EHWJZL.js";import"./chunk-AB3PYKT6.js";import{s as T}from"./chunk-L3SKP5V6.js";import{Ab as b,Eb as M,Ib as g,Jb as p,Nb as W,Ob as J,Pa as N,Pb as K,Qa as F,Rb as u,Sb as y,Tb as Q,Ua as l,_ as j,a as _,b as x,cb as O,ea as q,f as U,fa as m,ga as h,hb as I,oa as B,ob as L,oc as A,pb as f,pc as G,rb as v,tb as S,ua as d,wb as H,xb as D,yb as a,zb as s}from"./chunk-GWDYAHF2.js";var ie=["messagesViewport"],ae=(o,t)=>t.id;function oe(o,t){if(o&1&&(a(0,"div",16)(1,"span",18),u(2),s(),b(3,"span",19),s()),o&2){let e=p().$implicit;l(2),y(e.content)}}function se(o,t){if(o&1&&b(0,"div",17),o&2){let e=p().$implicit,n=p();f("innerHTML",n.formatMessage(e.content),N)}}function ce(o,t){if(o&1&&(a(0,"article",14)(1,"div",15),I(2,oe,4,1,"div",16)(3,se,1,1,"div",17),s()()),o&2){let e=t.$implicit;v("user",e.role==="user")("assistant",e.role==="assistant")("thinking",e.status==="thinking")("error",e.status==="error")("cancelled",e.status==="cancelled"),l(2),S(e.status==="thinking"?2:3)}}function le(o,t){if(o&1&&(a(0,"p",7),u(1),s()),o&2){let e=p();l(),y(e.sendError())}}function de(o,t){if(o&1){let e=M();a(0,"div",20),g("click",function(){m(e);let r=p();return h(r.closeImagePreview())}),a(1,"div",21),g("click",function(r){return m(e),h(r.stopPropagation())}),a(2,"button",22),g("click",function(){m(e);let r=p();return h(r.closeImagePreview())}),b(3,"i",23),s(),b(4,"img",24),s()()}if(o&2){let e=p();l(4),f("src",e.imagePreviewUrl(),F)("alt",e.imagePreviewAlt())}}var V=class o{chatService=j(Z);sanitizer=j(X);seedMessages=null;conversationChange=new B;messagesViewport;messages=d([this.buildWelcomeMessage()]);draft=d("");sendError=d(null);imagePreviewVisible=d(!1);imagePreviewUrl=d("");imagePreviewAlt=d("Imagen de proyecto");isBusy=A(()=>this.activeRequest()!==null);activeRequest=d(null);requestCounter=0;lastConversationSignature="";renderedMessageCache=new Map;constructor(){G(()=>{let t=this.messages();this.emitConversation(t),queueMicrotask(()=>this.scrollToBottom())})}ngOnChanges(t){if(!t.seedMessages)return;this.cancelInFlightRequest();let e=this.seedMessages;if(!e||e.length===0){this.messages.set([this.buildWelcomeMessage()]);return}this.messages.set(e.map(n=>({id:this.makeId(),role:n.role,content:n.content,status:"final"})))}ngAfterViewInit(){this.scrollToBottom()}setDraft(t){this.draft.set(t)}send(){return U(this,null,function*(){let t=this.draft().trim();if(!t)return;this.cancelInFlightRequest(),this.sendError.set(null),this.pushMessage({id:this.makeId(),role:"user",content:t,status:"final"}),this.draft.set("");let e=this.detectIntent(t),n=this.dynamicStatesFor(t,e),r=this.makeId();this.pushMessage({id:r,role:"assistant",content:n[0],status:"thinking"});let i={token:++this.requestCounter,assistantMessageId:r,timerId:null,canceled:!1,subscription:null,rejectPending:null};this.activeRequest.set(i),this.startDynamicStateLoop(i,n,1);try{let c=yield this.fetchAssistantResponse(t,i);if(!this.isRequestActive(i.token))return;this.finalizeAssistantMessage(i.assistantMessageId,c)}catch{if(!this.isRequestActive(i.token))return;this.markAssistantError(i.assistantMessageId,"No pude completar la respuesta en este momento. Intenta nuevamente."),this.sendError.set("Fallo la comunicacion con el backend del chatbot.")}finally{this.clearActiveRequestIfMatches(i.token)}})}onInputKeydown(t){t.key!=="Enter"||t.shiftKey||(t.preventDefault(),this.send())}onMessagesClick(t){let e=t.target;if(!e||e.tagName.toLowerCase()!=="img"||!e.classList.contains("chat-inline-image")&&!e.classList.contains("chat-project-thumb"))return;let n=e.getAttribute("src")?.trim()??"";n&&(this.imagePreviewUrl.set(n),this.imagePreviewAlt.set(e.getAttribute("alt")?.trim()||"Imagen de proyecto"),this.imagePreviewVisible.set(!0))}closeImagePreview(){this.imagePreviewVisible.set(!1),this.imagePreviewUrl.set("")}fetchAssistantResponse(t,e){return new Promise((n,r)=>{e.rejectPending=r,e.subscription=this.chatService.sendMessage({message:t}).subscribe({next:i=>n(i),error:i=>r(i)})})}detectIntent(t){let e=this.normalize(t),n=r=>r.some(i=>e.includes(i));return n(["proyecto","proyectos","portfolio","portafolio","l2terra","demo","github"])?"project":n(["stack","tecnologia","tecnologias","framework","backend","frontend","java","spring","angular","typescript"])?"stack":n(["experiencia","trayectoria","trabajaste","historial","perfil","seniority","actualmente"])?"experience":n(["contacto","email","linkedin","contratar","contratacion","disponibilidad","cv"])?"contact":"general"}dynamicStatesFor(t,e){let n=this.normalize(t),r=i=>i.some(c=>n.includes(c));return e==="project"?r(["imagen","imagenes","captura","screenshot","foto"])?["Buscando imagen principal del proyecto","Verificando que la imagen sea publica","Preparando vista previa del proyecto"]:r(["actualmente","destacado","destacados","trabajando","enfoque"])?["Revisando proyectos destacados","Validando contexto actual del portafolio","Armando respuesta priorizada por relevancia"]:["Revisando proyectos publicados","Extrayendo stack y funcionalidades clave","Preparando resumen tecnico del proyecto"]:e==="stack"?["Revisando stack declarado en el portafolio","Contrastando tecnologias con proyectos publicos","Organizando respuesta por categorias tecnicas"]:e==="experience"?r(["actualmente","hoy","ahora"])?["Revisando foco actual de trabajo","Contrastando proyectos recientes publicados","Preparando respuesta con contexto temporal"]:["Analizando perfil y trayectoria tecnica","Contrastando informacion con proyectos publicados","Preparando respuesta orientada a reclutadores"]:e==="contact"?r(["cv","curriculum","resume"])?["Buscando informacion de CV y contacto","Validando enlaces publicos disponibles","Preparando respuesta para oportunidades laborales"]:["Verificando disponibilidad laboral","Buscando informacion de contacto","Preparando respuesta de seguimiento"]:["Analizando consulta","Procesando informacion disponible","Generando respuesta"]}startDynamicStateLoop(t,e,n){if(!this.isRequestActive(t.token))return;let r=this.randomDelayMs(1400,2200);t.timerId=setTimeout(()=>{if(!this.isRequestActive(t.token))return;let i=Math.min(n,e.length-1);this.replaceMessageContent(t.assistantMessageId,e[i],"thinking"),i<e.length-1&&this.startDynamicStateLoop(t,e,i+1)},r)}cancelInFlightRequest(){let t=this.activeRequest();t&&(t.canceled=!0,t.timerId&&clearTimeout(t.timerId),t.subscription?.unsubscribe(),t.rejectPending?.(new Error("request-canceled")),this.replaceMessageContent(t.assistantMessageId,"Consulta interrumpida por una nueva pregunta.","cancelled"),this.activeRequest.set(null))}finalizeAssistantMessage(t,e){this.messages.update(n=>n.map(r=>r.id===t?x(_({},r),{content:e.answer,status:"final"}):r))}markAssistantError(t,e){this.replaceMessageContent(t,e,"error")}replaceMessageContent(t,e,n){this.messages.update(r=>r.map(i=>i.id===t?x(_({},i),{content:e,status:n}):i))}pushMessage(t){this.messages.update(e=>[...e,t])}isRequestActive(t){return this.activeRequest()?.token===t}clearActiveRequestIfMatches(t){let e=this.activeRequest();!e||e.token!==t||(e.timerId&&clearTimeout(e.timerId),e.subscription?.unsubscribe(),this.activeRequest.set(null))}normalize(t){return t.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9\s]/g," ").replace(/\s+/g," ").trim()}randomDelayMs(t,e){return Math.floor(Math.random()*(e-t+1))+t}makeId(){return`msg_${Date.now()}_${Math.random().toString(16).slice(2,8)}`}buildWelcomeMessage(){return{id:this.makeId(),role:"assistant",content:"Hola. Soy el asistente del portafolio de Juan Encabo. Podes preguntarme por proyectos, stack, experiencia o contacto.",status:"final"}}emitConversation(t){let e=t.filter(r=>r.status==="final").map(r=>({role:r.role,content:r.content})),n=JSON.stringify(e);n!==this.lastConversationSignature&&(this.lastConversationSignature=n,this.conversationChange.emit(e))}scrollToBottom(){let t=this.messagesViewport?.nativeElement;t&&(t.scrollTop=t.scrollHeight)}formatMessage(t){let e=this.extractProjectCards(t),P=this.escapeHtml(e.text).replace(/!\[([^\]]*)\]\(((?:https?:\/\/|\/)[^\s)]+)\)/g,(te,k,R)=>{let C=this.cleanDetectedUrl(R);return this.isSafeUrl(C,!0)?`<img src="${this.resolveAssetUrl(C)}" alt="${k||"Imagen de proyecto"}" loading="lazy" class="chat-inline-image" />`:""}).replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g,(te,k,R)=>{let C=this.cleanDetectedUrl(R);return this.isSafeUrl(C,!1)?`<a href="${C}" target="_blank" rel="noopener noreferrer">${k}</a>`:k}).replace(/(^|[\s(>])(https?:\/\/[^\s<"]+)/g,'$1<a href="$2" target="_blank" rel="noopener noreferrer">$2</a>').replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>").replace(/(^|[^*])\*(?!\s)(.+?)(?<!\s)\*/g,"$1<em>$2</em>").replace(/`([^`]+)`/g,"<code>$1</code>").replace(/^###\s+(.+)$/gm,"<h3>$1</h3>").replace(/^##\s+(.+)$/gm,"<h2>$1</h2>").replace(/^#\s+(.+)$/gm,"<h1>$1</h1>").replace(/\n/g,"<br>");P+=this.buildProjectCardsHtml(e.cards);let $=this.renderedMessageCache.get(P);if($)return $;let z=this.sanitizer.bypassSecurityTrustHtml(P);return this.renderedMessageCache.set(P,z),z}escapeHtml(t){return(t??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}resolveAssetUrl(t){if(!t)return"";if(t.startsWith("http://")||t.startsWith("https://"))return t;let e=E.apiBaseUrl.endsWith("/")?E.apiBaseUrl.slice(0,-1):E.apiBaseUrl,n=t.startsWith("/")?t:`/${t}`;return`${e}${n}`}cleanDetectedUrl(t){let e=(t??"").trim();return e=e.replace(/[),.;:!?]+$/g,""),e.endsWith("]")&&(e=e.slice(0,-1)),e}isSafeUrl(t,e){return t?e&&t.startsWith("/")?!0:/^https?:\/\//i.test(t):!1}extractProjectCards(t){let e=/\[PROJECT_CARD\s+title="([^"]+)"\s+image="([^"]+)"\s+link="([^"]+)"\]/g,n=[],r=t??"",i;for(;(i=e.exec(t??""))!==null;)n.push({title:i[1]?.trim()??"",image:this.cleanDetectedUrl(i[2]??""),link:(i[3]??"").trim()}),r=r.replace(i[0],"");return{text:r.trim(),cards:n}}buildProjectCardsHtml(t){if(!t.length)return"";let e=t.filter(n=>n.title&&this.isSafeUrl(n.image,!0)&&this.isSafeUrl(n.link,!0)).map(n=>{let r=this.escapeHtml(n.title),i=this.resolveAssetUrl(n.image),c=n.link.startsWith("/")?n.link:this.cleanDetectedUrl(n.link);return`
          <div class="chat-project-card">
            <img src="${i}" alt="${r}" loading="lazy" class="chat-project-thumb" />
            <div class="chat-project-body">
              <strong class="chat-project-title">${r}</strong>
              <a href="${c}" target="_blank" rel="noopener noreferrer" class="chat-project-link">Ver proyecto</a>
            </div>
          </div>
        `}).join("");return e?`<div class="chat-project-cards">${e}</div>`:""}static \u0275fac=function(e){return new(e||o)};static \u0275cmp=O({type:o,selectors:[["app-chat"]],viewQuery:function(e,n){if(e&1&&W(ie,5),e&2){let r;J(r=K())&&(n.messagesViewport=r.first)}},inputs:{seedMessages:"seedMessages"},outputs:{conversationChange:"conversationChange"},features:[q],decls:18,vars:13,consts:[["messagesViewport",""],[1,"chat-card"],[1,"chat-header"],[1,"fas","fa-robot"],[1,"chat-status"],[1,"chat-messages",3,"click"],[1,"chat-message",3,"user","assistant","thinking","error","cancelled"],[1,"chat-error"],[1,"chat-input-row"],[1,"chat-input-wrap"],["rows","2","placeholder","Pregunta por proyectos, stack, experiencia o contacto...",1,"chat-input",3,"input","keydown","value"],["type","button",1,"chat-send",3,"click","title","disabled"],["aria-hidden","true",1,"fas"],[1,"chat-image-preview-overlay"],[1,"chat-message"],[1,"bubble"],[1,"bubble-content","bubble-thinking"],[1,"bubble-content",3,"innerHTML"],[1,"thinking-text"],["aria-hidden","true",1,"thinking-dots"],[1,"chat-image-preview-overlay",3,"click"],[1,"chat-image-preview-content",3,"click"],["type","button","aria-label","Cerrar",1,"chat-image-preview-close",3,"click"],[1,"fas","fa-times"],[1,"chat-image-preview-full",3,"src","alt"]],template:function(e,n){if(e&1){let r=M();a(0,"section",1)(1,"header",2)(2,"h3"),b(3,"i",3),u(4," Asistente IA"),s(),a(5,"span",4),u(6),s()(),a(7,"div",5,0),g("click",function(c){return m(r),h(n.onMessagesClick(c))}),H(9,ce,4,11,"article",6,ae),s(),I(11,le,2,1,"p",7),a(12,"div",8)(13,"div",9)(14,"textarea",10),g("input",function(c){return m(r),h(n.setDraft(c.target.value))})("keydown",function(c){return m(r),h(n.onInputKeydown(c))}),s(),a(15,"button",11),g("click",function(){return m(r),h(n.send())}),b(16,"i",12),s()()()(),I(17,de,5,2,"div",13)}e&2&&(l(5),v("busy",n.isBusy()),l(),Q(" ",n.isBusy()?"Procesando":"Listo"," "),l(3),D(n.messages()),l(2),S(n.sendError()?11:-1),l(3),f("value",n.draft()),l(),f("title",n.isBusy()?"Enviar (cancela anterior)":"Enviar")("disabled",!n.draft().trim()),L("aria-label",n.isBusy()?"Cancelar envio anterior y reenviar":"Enviar mensaje"),l(),v("fa-paper-plane",!n.isBusy())("fa-rotate-right",n.isBusy()),l(),S(n.imagePreviewVisible()?17:-1))},dependencies:[T],styles:['[_nghost-%COMP%]{display:block;height:100%;min-height:0}.chat-card[_ngcontent-%COMP%]{height:100%;min-height:0;display:flex;flex-direction:column;border-radius:12px;border:1px solid color-mix(in srgb,var(--color-primary) 20%,transparent);background:color-mix(in srgb,var(--color-primary) 6%,var(--background-dark));padding:1rem;box-shadow:var(--shadow-card)}.chat-header[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:space-between;gap:.75rem;margin-bottom:.75rem}.chat-header[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0;font-size:1rem;display:inline-flex;align-items:center;gap:.5rem}.chat-header[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{color:var(--color-primary)}.chat-status[_ngcontent-%COMP%]{font-size:.72rem;text-transform:uppercase;letter-spacing:.08em;color:var(--color-text-secondary)}.chat-status.busy[_ngcontent-%COMP%]{color:var(--color-primary)}.chat-messages[_ngcontent-%COMP%]{flex:1;min-height:260px;overflow-y:auto;border:1px solid color-mix(in srgb,var(--color-text-primary) 15%,transparent);border-radius:10px;padding:.75rem;background:color-mix(in srgb,var(--color-text-primary) 5%,transparent)}.chat-message[_ngcontent-%COMP%]{display:flex;margin-bottom:.6rem}.chat-message.user[_ngcontent-%COMP%]{justify-content:flex-end}.chat-message.assistant[_ngcontent-%COMP%]{justify-content:flex-start}.bubble[_ngcontent-%COMP%]{max-width:min(88%,720px);border-radius:10px;padding:.6rem .75rem;border:1px solid transparent}.chat-message.user[_ngcontent-%COMP%]   .bubble[_ngcontent-%COMP%]{background:color-mix(in srgb,var(--color-primary) 20%,transparent);border-color:color-mix(in srgb,var(--color-primary) 35%,transparent)}.chat-message.assistant[_ngcontent-%COMP%]   .bubble[_ngcontent-%COMP%]{background:color-mix(in srgb,var(--color-text-primary) 10%,transparent);border-color:color-mix(in srgb,var(--color-text-primary) 18%,transparent)}.chat-message.error[_ngcontent-%COMP%]   .bubble[_ngcontent-%COMP%]{border-color:color-mix(in srgb,#ef4444 45%,transparent)}.chat-message.cancelled[_ngcontent-%COMP%]   .bubble[_ngcontent-%COMP%]{border-color:color-mix(in srgb,#f59e0b 45%,transparent)}.bubble-content[_ngcontent-%COMP%]{margin:0;line-height:1.4;overflow-wrap:anywhere}.bubble-content[_ngcontent-%COMP%]   a[_ngcontent-%COMP%]{color:#7dd3fc;text-decoration:underline}.bubble-content[_ngcontent-%COMP%]   code[_ngcontent-%COMP%]{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace;background:color-mix(in srgb,var(--color-text-primary) 18%,transparent);padding:.1rem .3rem;border-radius:.35rem}[_nghost-%COMP%]     .bubble-content h1, [_nghost-%COMP%]     .bubble-content h2, [_nghost-%COMP%]     .bubble-content h3{margin:.45rem 0 .35rem;line-height:1.2;color:var(--color-text-primary)}[_nghost-%COMP%]     .bubble-content h1{font-size:1.08rem}[_nghost-%COMP%]     .bubble-content h2{font-size:1rem}[_nghost-%COMP%]     .bubble-content h3{font-size:.93rem}[_nghost-%COMP%]     .bubble-content img{max-width:100%!important;height:auto!important;display:block}[_nghost-%COMP%]     .bubble-content .chat-inline-image{display:block;width:min(100%,340px)!important;max-width:100%!important;max-height:220px;object-fit:cover;border-radius:.65rem;margin-top:.45rem;border:1px solid color-mix(in srgb,var(--color-text-primary) 20%,transparent);cursor:zoom-in}[_nghost-%COMP%]     .bubble-content .chat-project-cards{margin-top:.75rem;display:grid;gap:.7rem}[_nghost-%COMP%]     .bubble-content .chat-project-card{border:1px solid color-mix(in srgb,var(--color-primary) 25%,transparent);border-radius:.7rem;overflow:hidden;background:color-mix(in srgb,var(--color-primary) 7%,transparent);max-width:min(100%,340px)}[_nghost-%COMP%]     .bubble-content .chat-project-thumb{width:100%;max-height:170px;object-fit:cover;display:block;cursor:zoom-in}[_nghost-%COMP%]     .bubble-content .chat-project-body{padding:.6rem .7rem .7rem;display:flex;align-items:center;justify-content:space-between;gap:.7rem}[_nghost-%COMP%]     .bubble-content .chat-project-title{font-size:.9rem;line-height:1.2}[_nghost-%COMP%]     .bubble-content .chat-project-link{text-decoration:none;border:1px solid color-mix(in srgb,var(--color-primary) 40%,transparent);background:color-mix(in srgb,var(--color-primary) 12%,transparent);border-radius:999px;color:var(--color-text-primary);font-size:.75rem;font-weight:700;padding:.28rem .62rem;white-space:nowrap}.chat-image-preview-overlay[_ngcontent-%COMP%]{position:fixed;inset:0;z-index:1200;background:#000000d1;display:flex;align-items:center;justify-content:center;padding:1rem}.chat-image-preview-content[_ngcontent-%COMP%]{position:relative;max-width:min(95vw,1100px);max-height:90vh}.chat-image-preview-close[_ngcontent-%COMP%]{position:absolute;top:-.6rem;right:-.6rem;width:2rem;height:2rem;border:none;border-radius:999px;background:color-mix(in srgb,var(--color-primary) 72%,black);color:var(--color-text-primary);cursor:pointer;z-index:1}.chat-image-preview-full[_ngcontent-%COMP%]{display:block;max-width:100%;max-height:90vh;border-radius:.7rem;border:1px solid color-mix(in srgb,var(--color-text-primary) 22%,transparent)}.thinking-dots[_ngcontent-%COMP%]:after{content:"...";display:inline-block;animation:_ngcontent-%COMP%_chatDots 1s steps(4,end) infinite}.bubble-content.bubble-thinking[_ngcontent-%COMP%]{display:inline-flex;align-items:center;gap:.3rem}.bubble-content.bubble-thinking[_ngcontent-%COMP%]   .thinking-text[_ngcontent-%COMP%]{line-height:1.3}.chat-error[_ngcontent-%COMP%]{margin:.5rem 0 0;color:#f87171;font-size:.85rem}.chat-input-row[_ngcontent-%COMP%]{display:block;margin-top:.7rem}.chat-input-wrap[_ngcontent-%COMP%]{position:relative}.chat-input[_ngcontent-%COMP%]{width:100%;resize:vertical;min-height:54px;max-height:140px;border-radius:10px;border:1px solid color-mix(in srgb,var(--color-text-primary) 22%,transparent);background:color-mix(in srgb,var(--color-text-primary) 8%,transparent);color:var(--color-text-primary);padding:.65rem 8.2rem .65rem .75rem;font:inherit}.chat-input[_ngcontent-%COMP%]:focus{outline:none;border-color:var(--color-primary)}.chat-send[_ngcontent-%COMP%]{position:absolute;right:.45rem;bottom:.75rem;min-height:38px;width:38px;min-width:38px;padding:0;border:none;border-radius:999px;background:var(--color-primary);color:var(--color-primary-contrast, #0b1211);font-weight:700;cursor:pointer;display:inline-flex;align-items:center;justify-content:center}.chat-send[_ngcontent-%COMP%]:disabled{opacity:.6;cursor:not-allowed}@media (max-width: 768px){.chat-messages[_ngcontent-%COMP%]{min-height:240px}.chat-input-row[_ngcontent-%COMP%]{display:block}.chat-send[_ngcontent-%COMP%]{width:38px;min-width:38px}}@keyframes _ngcontent-%COMP%_chatDots{0%{content:"."}33%{content:".."}66%{content:"..."}to{content:"."}}']})};function pe(o,t){if(o&1){let e=M();a(0,"div",12),g("click",function(){let r=m(e).$implicit,i=p();return h(i.selectHistory(r.id))})("keydown.enter",function(){let r=m(e).$implicit,i=p();return h(i.selectHistory(r.id))})("keydown.space",function(r){let i=m(e).$implicit;return p().selectHistory(i.id),h(r.preventDefault())}),a(1,"span",13)(2,"span",14),u(3),s(),a(4,"button",15),g("click",function(r){let i=m(e).$implicit,c=p();return h(c.openDeleteHistoryConfirm(i.id,r))}),b(5,"i",16),s()(),a(6,"span",17),u(7),s()()}if(o&2){let e=t.$implicit,n=p();v("active",n.selectedHistoryId()===e.id),l(3),y(e.title),l(4),y(n.formatUpdatedAt(e.updatedAt))}}var ee=class o{storageKey="dashboard_chat_histories_v1";histories=d(this.loadHistories());selectedHistoryId=d(null);activeSeedMessages=d(null);deleteModalVisible=d(!1);pendingDeleteHistoryId=d(null);sortedHistories=A(()=>[...this.histories()].sort((t,e)=>Date.parse(e.updatedAt)-Date.parse(t.updatedAt)));constructor(){let t=this.sortedHistories()[0];t?this.selectHistory(t.id):this.createNewChat()}createNewChat(){let t=this.makeId(),e=new Date().toISOString(),n={id:t,title:"Nuevo chat",updatedAt:e,messages:[]};this.histories.update(r=>[n,...r]),this.selectedHistoryId.set(t),this.activeSeedMessages.set([]),this.persistHistories()}selectHistory(t){this.selectedHistoryId.set(t);let e=this.histories().find(n=>n.id===t);this.activeSeedMessages.set(e?.messages??[])}openDeleteHistoryConfirm(t,e){e.stopPropagation(),this.pendingDeleteHistoryId.set(t),this.deleteModalVisible.set(!0)}closeDeleteHistoryConfirm(){this.deleteModalVisible.set(!1),this.pendingDeleteHistoryId.set(null)}confirmDeleteHistory(){let t=this.pendingDeleteHistoryId();if(!t){this.closeDeleteHistoryConfirm();return}let e=this.histories().filter(r=>r.id!==t);if(this.histories.set(e),this.persistHistories(),this.selectedHistoryId()===t){let r=this.sortedHistories()[0];r?this.selectHistory(r.id):this.createNewChat()}this.closeDeleteHistoryConfirm()}onConversationChange(t){let e=this.selectedHistoryId();if(!e)return;let n=t.filter(c=>c.content.trim().length>0),r=this.histories().find(c=>c.id===e);!r||JSON.stringify(r.messages)===JSON.stringify(n)||(this.histories.update(c=>c.map(w=>w.id!==e?w:x(_({},w),{messages:n,title:this.resolveTitle(n),updatedAt:new Date().toISOString()}))),this.persistHistories())}trackByHistoryId(t,e){return e.id}formatUpdatedAt(t){let e=new Date(t);return new Intl.DateTimeFormat("es-AR",{day:"2-digit",month:"2-digit",hour:"2-digit",minute:"2-digit"}).format(e)}getPendingDeleteTitle(){let t=this.pendingDeleteHistoryId();if(!t)return"este chat";let e=this.histories().find(n=>n.id===t);return e?`"${e.title}"`:"este chat"}resolveTitle(t){let e=t.find(n=>n.role==="user")?.content?.trim();return e?e.length>42?`${e.slice(0,42)}...`:e:"Nuevo chat"}loadHistories(){try{let t=localStorage.getItem(this.storageKey);if(!t)return[];let e=JSON.parse(t);return Array.isArray(e)?e.filter(n=>n&&typeof n.id=="string"&&typeof n.title=="string"&&typeof n.updatedAt=="string"&&Array.isArray(n.messages)):[]}catch{return[]}}persistHistories(){localStorage.setItem(this.storageKey,JSON.stringify(this.histories()))}makeId(){return`chat_${Date.now()}_${Math.random().toString(16).slice(2,8)}`}static \u0275fac=function(e){return new(e||o)};static \u0275cmp=O({type:o,selectors:[["app-dashboard-chat"]],decls:21,vars:3,consts:[[1,"dashboard-chat-page"],[1,"dashboard-chat-header"],[1,"beta-badge"],[1,"dashboard-chat-layout"],[1,"history-panel"],[1,"history-panel-header"],["type","button",1,"history-new-btn",3,"click"],[1,"history-list"],["role","button","tabindex","0",1,"history-item",3,"active"],[1,"chat-panel"],[3,"conversationChange","seedMessages"],["type","danger","title","Borrar chat","confirmText","Borrar","cancelText","Cancelar",3,"confirmed","cancelled","visible","message"],["role","button","tabindex","0",1,"history-item",3,"click","keydown.enter","keydown.space"],[1,"history-row"],[1,"history-title"],["type","button","title","Borrar chat","aria-label","Borrar chat",1,"history-delete-btn",3,"click"],["aria-hidden","true",1,"fas","fa-times"],[1,"history-time"]],template:function(e,n){e&1&&(a(0,"section",0)(1,"header",1)(2,"h1"),u(3,"Chat del Portafolio "),a(4,"span",2),u(5,"Beta"),s()(),a(6,"p"),u(7,"Asistente conversacional para consultas sobre perfil, stack, proyectos y contacto."),s()(),a(8,"div",3)(9,"aside",4)(10,"div",5)(11,"h2"),u(12,"Historial"),s(),a(13,"button",6),g("click",function(){return n.createNewChat()}),u(14,"Nuevo chat"),s()(),a(15,"div",7),H(16,pe,8,4,"div",8,n.trackByHistoryId,!0),s()(),a(18,"section",9)(19,"app-chat",10),g("conversationChange",function(i){return n.onConversationChange(i)}),s()()()(),a(20,"app-confirm-modal",11),g("confirmed",function(){return n.confirmDeleteHistory()})("cancelled",function(){return n.closeDeleteHistoryConfirm()}),s()),e&2&&(l(16),D(n.sortedHistories()),l(3),f("seedMessages",n.activeSeedMessages()),l(),f("visible",n.deleteModalVisible())("message","Se eliminara "+n.getPendingDeleteTitle()+". Esta accion no se puede deshacer."))},dependencies:[T,V,Y],styles:["[_nghost-%COMP%]{display:flex;flex:1;min-height:0}.dashboard-chat-page[_ngcontent-%COMP%]{flex:1;min-height:0;width:100%;display:flex;flex-direction:column;padding:var(--spacing-lg) var(--spacing-xl);overflow:hidden}.dashboard-chat-header[_ngcontent-%COMP%]{margin-bottom:.9rem}.dashboard-chat-header[_ngcontent-%COMP%]   h1[_ngcontent-%COMP%]{margin:0;font-size:clamp(1.5rem,4vw,2rem);color:var(--color-text-primary);display:inline-flex;align-items:center;gap:.55rem}.dashboard-chat-header[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{margin:.4rem 0 0;color:var(--color-text-secondary)}.beta-badge[_ngcontent-%COMP%]{font-size:.72rem;font-weight:800;text-transform:uppercase;letter-spacing:.08em;border-radius:999px;padding:.18rem .55rem;border:1px solid color-mix(in srgb,var(--color-primary) 45%,transparent);color:var(--color-primary);background:color-mix(in srgb,var(--color-primary) 14%,transparent)}.dashboard-chat-layout[_ngcontent-%COMP%]{display:grid;grid-template-columns:300px 1fr;gap:1rem;flex:1;min-height:0}.history-panel[_ngcontent-%COMP%]{min-height:0;height:100%;border:1px solid color-mix(in srgb,var(--color-primary) 16%,transparent);border-radius:12px;background:color-mix(in srgb,var(--color-primary) 5%,var(--background-dark));padding:.85rem;display:flex;flex-direction:column}.history-panel-header[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:space-between;gap:.75rem;margin-bottom:.7rem}.history-panel-header[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{margin:0;font-size:.95rem}.history-new-btn[_ngcontent-%COMP%]{border:1px solid color-mix(in srgb,var(--color-primary) 55%,transparent);background:transparent;color:var(--color-primary);border-radius:8px;padding:.35rem .55rem;font-size:.75rem;font-weight:700;cursor:pointer}.history-list[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.45rem;overflow-y:auto;min-height:0}.history-item[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.2rem;text-align:left;width:100%;border:1px solid color-mix(in srgb,var(--color-text-primary) 16%,transparent);background:color-mix(in srgb,var(--color-text-primary) 6%,transparent);color:var(--color-text-primary);border-radius:8px;padding:.55rem .6rem;cursor:pointer}.history-item[_ngcontent-%COMP%]:focus-visible{outline:2px solid color-mix(in srgb,var(--color-primary) 65%,transparent);outline-offset:1px}.history-item.active[_ngcontent-%COMP%]{border-color:color-mix(in srgb,var(--color-primary) 60%,transparent);background:color-mix(in srgb,var(--color-primary) 15%,transparent)}.history-row[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:space-between;gap:.4rem}.history-title[_ngcontent-%COMP%]{font-size:.84rem;line-height:1.35;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.history-time[_ngcontent-%COMP%]{font-size:.7rem;color:var(--color-text-secondary)}.history-delete-btn[_ngcontent-%COMP%]{width:1.45rem;height:1.45rem;border:none;border-radius:50%;background:transparent;color:var(--color-text-secondary);cursor:pointer;display:inline-flex;align-items:center;justify-content:center;flex-shrink:0}.history-delete-btn[_ngcontent-%COMP%]:hover{color:#f87171;background:color-mix(in srgb,#ef4444 16%,transparent)}.chat-panel[_ngcontent-%COMP%]{height:100%;min-width:0;min-height:0}.chat-panel[_ngcontent-%COMP%]   app-chat[_ngcontent-%COMP%]{display:block;height:100%}@media (max-width: 768px){.dashboard-chat-page[_ngcontent-%COMP%]{padding:var(--spacing-md);overflow:auto}.dashboard-chat-layout[_ngcontent-%COMP%]{grid-template-columns:1fr;gap:.8rem}.history-panel[_ngcontent-%COMP%]{height:auto;max-height:240px}}"]})};export{ee as DashboardChatComponent};
