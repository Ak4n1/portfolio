import{c as r}from"./chunk-RHAAQPZP.js";import{U as c,_ as o,l as n,m as i}from"./chunk-VJKI3SXJ.js";var N="/api/ws/notifications",I="http://localhost:8080",a=class s{ws=null;connectionState$=new i("DISCONNECTED");messages$=new n;reconnectAttempts=0;maxReconnectAttempts=5;reconnectDelay=3e3;reconnectTimer=null;isManualClose=!1;tokenRefreshInProgress=!1;authStateService=o(r);connectionState;messages;constructor(){this.connectionState=this.connectionState$.asObservable(),this.messages=this.messages$.asObservable(),this.authStateService.authState.subscribe(e=>{e.isAuthenticated&&!e.isLoading?this.connect():e.isLoading||this.disconnect()})}connect(){if(this.ws?.readyState===WebSocket.OPEN||this.ws?.readyState===WebSocket.CONNECTING)return;this.isManualClose=!1,this.connectionState$.next("CONNECTING");let e=window.location.protocol==="https:"?"wss:":"ws:",t=I.replace(/^https?:\/\//,"").replace(/\/$/,""),E=`${e}//${t}${N}`;try{this.ws=new WebSocket(E),this.ws.onopen=()=>{this.connectionState$.next("CONNECTED"),this.reconnectAttempts=0},this.ws.onmessage=h=>this.handleMessage(h.data),this.ws.onerror=()=>{this.connectionState$.next("ERROR")},this.ws.onclose=()=>{!this.isManualClose&&this.reconnectAttempts<this.maxReconnectAttempts?this.scheduleReconnect():this.connectionState$.next("DISCONNECTED")}}catch{this.connectionState$.next("ERROR"),this.scheduleReconnect()}}disconnect(){this.isManualClose=!0,this.reconnectTimer&&(clearTimeout(this.reconnectTimer),this.reconnectTimer=null),this.ws&&(this.ws.close(),this.ws=null),this.connectionState$.next("DISCONNECTED")}handleMessage(e){try{let t=JSON.parse(e);switch(t.type){case"CONTACT_SUBMITTED":case"USER_REGISTERED":case"ONLINE_USERS_COUNT":case"EMAIL_VERIFIED":case"NOTIFICATION_COUNT_UPDATED":case"PROJECT_LIKED":case"ACTIVITY_LOGGED":case"NEWS_BROADCASTED":this.messages$.next(t);break;case"PING":this.sendMessage({type:"PONG",timestamp:t.timestamp});break;case"TOKEN_REFRESH_REQUIRED":this.handleTokenRefreshRequired();break;case"IDLE_TIMEOUT":break;case"SERVER_SHUTDOWN":this.handleServerShutdown(t.reconnectInSeconds??30);break;default:break}}catch{}}handleTokenRefreshRequired(){this.tokenRefreshInProgress||(this.tokenRefreshInProgress=!0,this.authStateService.refreshUserState().then(()=>{this.disconnect(),setTimeout(()=>{this.tokenRefreshInProgress=!1,this.connect()},1e3)}).catch(()=>{this.tokenRefreshInProgress=!1,this.disconnect()}))}handleServerShutdown(e){this.disconnect(),setTimeout(()=>{this.isManualClose=!1,this.connect()},e*1e3)}scheduleReconnect(){if(this.isManualClose)return;this.reconnectAttempts++,this.connectionState$.next("RECONNECTING");let e=this.reconnectDelay*this.reconnectAttempts;this.reconnectTimer=setTimeout(()=>this.connect(),e)}sendMessage(e){if(this.ws?.readyState===WebSocket.OPEN)try{this.ws.send(JSON.stringify(e))}catch{}}getCurrentState(){return this.connectionState$.value}static \u0275fac=function(t){return new(t||s)};static \u0275prov=c({token:s,factory:s.\u0275fac,providedIn:"root"})};export{a};
